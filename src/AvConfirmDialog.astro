---
import { AvButton } from "@ansiversa/components";

interface Props {
  id: string;
  headline?: string;
  description?: string;
  confirmLabel?: string;
  cancelLabel?: string;
  variant?: "default" | "danger";
  busy?: boolean;
  className?: string;
}

const {
  id,
  headline = "Confirm",
  description,
  confirmLabel = "Confirm",
  cancelLabel = "Cancel",
  variant = "default",
  busy = false,
  className = "",
  ...attrs
} = Astro.props as Props & Record<string, unknown>;

if (!id) {
  throw new Error("AvConfirmDialog requires an `id` prop.");
}

const labelId = `${id}-title`;
const descId = description ? `${id}-desc` : undefined;
const dialogClass = `av-dialog av-dialog--${variant} ${className}`.trim();
---

<dialog
  id={id}
  class={dialogClass}
  aria-modal="true"
  aria-labelledby={labelId}
  aria-describedby={description ? descId : undefined}
  {...attrs}
>
  <div class="av-dialog__panel" role="document">
    <div class="av-dialog__header">
      <h2 class="av-dialog__title" id={labelId}>{headline}</h2>
      {description ? <p class="av-dialog__desc" id={descId}>{description}</p> : null}
    </div>

    <div class="av-dialog__footer">
      <AvButton type="button" variant="ghost" size="md" data-av-cancel disabled={busy}>
        {cancelLabel}
      </AvButton>

      <AvButton
        type="button"
        variant="primary"
        size="md"
        data-av-confirm
        className={variant === "danger" ? "av-dialog__confirm--danger" : ""}
        disabled={busy}
      >
        {busy ? "Working..." : confirmLabel}
      </AvButton>
    </div>
  </div>
</dialog>

<script define:vars={{ dialogId: id }}>
(() => {
  const dialog = document.getElementById(dialogId);
  if (!dialog) return;

  const confirmBtn = dialog.querySelector("[data-av-confirm]");
  const cancelBtn = dialog.querySelector("[data-av-cancel]");

  function dispatch(name) {
    dialog.dispatchEvent(
      new CustomEvent(name, { bubbles: true, detail: { id: dialogId } })
    );
  }

  function open() {
    if (!dialog.open && typeof dialog.showModal === "function") {
      dialog.showModal();
    }
  }

  function close() {
    if (dialog.open) dialog.close();
  }

  window.AvDialog = window.AvDialog || {};
  window.AvDialog.open = (targetId) => {
    if (targetId === dialogId) open();
  };
  window.AvDialog.close = (targetId) => {
    if (targetId === dialogId) close();
  };

  confirmBtn?.addEventListener("click", () => {
    dispatch("av-confirm");
    close();
  });

  cancelBtn?.addEventListener("click", () => {
    dispatch("av-cancel");
    close();
  });

  dialog.addEventListener("cancel", (e) => {
    e.preventDefault(); // Escape
    dispatch("av-cancel");
    close();
  });

  dialog.addEventListener("click", (e) => {
    if (e.target === dialog) {
      dispatch("av-cancel");
      close();
    }
  });
})();
</script>
