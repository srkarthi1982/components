---
import AvButton from "./AvButton.astro";

interface NavLink {
  label: string;
  href: string;
  variant?: "primary" | "ghost" | "outline";
  className?: string;
}

interface User {
  id: string;
  email: string;
  name?: string;
  roleId?: number;
}

interface Props {
  className?: string;
  user?: User;

  /** Additional HTML attributes */
  [attrs: string]: any;
}

const {
  className = "",
  user,
  ...attrs
} = Astro.props as Props;

const classes = ["av-navbar-actions"];
if (className) classes.push(className);
const classAttr = classes.join(" ");

const rawDomain = (import.meta.env.ANSIVERSA_COOKIE_DOMAIN || "ansiversa.com").trim();
const normalizedDomain = rawDomain.replace(/^(https?:\/\/)/i, "").replace(/\/+$/, "");
const protocol = rawDomain.match(/^https?:\/\//i)
  ? undefined
  : import.meta.env.PROD
    ? "https"
    : "http";
const ROOT_URL = rawDomain.match(/^https?:\/\//i)
  ? rawDomain.replace(/\/+$/, "")
  : `${protocol}://${normalizedDomain}`;

const iconMap: Record<string, string> = {
  Apps: `
    <svg class="av-icon" viewBox='0 0 24 24'>
      <rect x='3' y='3' width='7' height='7' rx='2'/>
      <rect x='14' y='3' width='7' height='7' rx='2'/>
      <rect x='3' y='14' width='7' height='7' rx='2'/>
      <rect x='14' y='14' width='7' height='7' rx='2'/>
    </svg>
  `,
  Pricing: `
    <svg class="av-icon" viewBox='0 0 24 24'>
      <path d='M6 3h7.586a2 2 0 0 1 1.414.586l4.414 4.414a2 2 0 0 1 0 2.828L13 18.242a2 2 0 0 1-2.828 0L3.586 11.657A2 2 0 0 1 3 10.243V6a3 3 0 0 1 3-3Z'/>
      <path d='M9 6h.01'/>
    </svg>
  `,
  About: `
    <svg class="av-icon" viewBox='0 0 24 24'>
      <circle cx='12' cy='8' r='3.25'/>
      <path d='M6 19v-.5a5.5 5.5 0 0 1 11 0V19'/>
      <path d='M12 12.5v2'/>
    </svg>
  `,
  default: `
    <svg class="av-icon" viewBox='0 0 24 24'>
      <circle cx='12' cy='12' r='9'/>
    </svg>
  `,
};

function renderIcon(label: string) {
  return iconMap[label] ?? iconMap.default;
}

// ALWAYS SHOW THESE LINKS
const baseLinks: NavLink[] = [
  { label: "Apps", href: `${ROOT_URL}/apps` },
  { label: "Pricing", href: `${ROOT_URL}/pricing` },
  { label: "About", href: `${ROOT_URL}/about` },
];

// SIGN-IN link only for guests
const authLink: NavLink = {
  label: "Sign in",
  href: `${ROOT_URL}/login`,
  variant: "primary",
};

const userInitial =
  (user?.name?.charAt(0) ?? user?.email?.charAt(0) ?? "?").toUpperCase();
---

<div class={classAttr} {...attrs}>
  <!-- Left: Always visible -->
  {baseLinks.map((item) => (
    <AvButton
      href={item.href}
      variant="ghost"
      className="av-nowrap"
    >
      <span class="av-nav-icon" set:html={renderIcon(item.label)}></span>
      <span class="av-nav-label">{item.label}</span>
    </AvButton>
  ))}

  <!-- Right: Sign-in OR User dropdown -->
  {user ? (
    <div class="av-user-menu-wrapper" x-data="{ open: false }">
      <button
        type="button"
        class="av-user-avatar-button"
        aria-label="Account menu"
        aria-haspopup="menu"
        x-on:click="open = !open"
        x-bind:aria-expanded="open"
      >
        <span class="av-user-avatar-circle" aria-hidden="true">
          {userInitial}
        </span>
      </button>

      <div
        x-show="open"
        x-cloak
        x-transition.origin.top.right
        x-on:click.outside="open = false"
        class="av-user-menu av-nav-user-menu"
        role="menu"
        aria-label="User menu"
      >
        <div class="av-user-menu-header">
          <div class="av-user-menu-avatar">{userInitial}</div>
          <div class="av-user-menu-meta">
            <p class="av-user-menu-name">{user.name}</p>
            <p class="av-user-menu-email">{user.email}</p>
          </div>
        </div>

        <div class="av-user-menu-divider"></div>

        <div class="av-nav-user-menu">
          {user?.roleId === 1 && (
            <a href={`${ROOT_URL}/admin`} class="av-user-menu-item av-dropdown-item" role="menuitem">
              <span>Administration</span>
            </a>
          )}

          <a href={`${ROOT_URL}/dashboard`} class="av-user-menu-item av-dropdown-item" role="menuitem">
            <span>Dashboard</span>
          </a>

          <a
            href={`${ROOT_URL}/change-password`}
            class="av-user-menu-item av-dropdown-item"
            role="menuitem"
          >
            <span>Change password</span>
          </a>

          <a href={`${ROOT_URL}/settings`} class="av-user-menu-item av-dropdown-item" role="menuitem">
            <span>Settings</span>
          </a>
          <a
              href={`${ROOT_URL}/signout`}
              class="av-user-menu-item av-dropdown-item av-user-menu-item--danger"
              role="menuitem"
            >
              <span>Sign out</span>
            </a>
        </div>
      </div>
    </div>
  ) : (
    <AvButton
      href={authLink.href}
      variant={authLink.variant}
      className="av-nowrap"
    >
      <span class="av-nav-icon" set:html={renderIcon(authLink.label)}></span>
      <span class="av-nav-label">{authLink.label}</span>
    </AvButton>
  )}
</div>
